<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa casas vacacionales</title>

  <!-- Mapbox GL -->
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
  <script defer src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>

  <!-- Mapbox Geocoder -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" rel="stylesheet" />
  <script defer src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>

  <!-- Scrollama (UMD) -->
  <script defer src="https://unpkg.com/scrollama"></script>

  <!-- mapbox-gl-globe-minimap -->
  <script defer src="https://unpkg.com/mapbox-gl-globe-minimap@latest/dist/mapbox-gl-globe-minimap.umd.js"></script>

  <style>
    /* Estilos de la UI y del mapa (idénticos al Svelte) */
    html, body{ margin:0; padding:0; overflow-x:hidden; font-family: Helvetica, sans-serif; }
    a, a:hover, a:visited{ color:#0071bc; }

    .toggle-free{
      position: fixed;
      top: 16px;
      left: 16px;
      right: auto;
      z-index: 1000;
      background:#01f3b3; color:#000; border:none;
      border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
    }
    .toggle-free:hover{ transform: translateY(-1px); }

    #map{ position: fixed; inset: 0; width: 100vw; height: 100vh; margin: 0 auto; z-index: 1; }

    /* Geocoder y popup */
    #map-container{ position: relative; width: 100%; max-width: 1200px; height: 600px; margin: auto; border-radius: 12px; overflow: hidden; }
    #geocoder-container{
      position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000;
      display: flex; justify-content: flex-end; pointer-events: none;
    }
    .mapboxgl-ctrl-geocoder{
      height: 36px !important; width: 100%; max-width: 300px; pointer-events: all; box-sizing: border-box;
    }
    .mapboxgl-ctrl-geocoder input{
      padding-left: 40px !important; background: white !important; border: none !important; font-size: 14px; box-sizing: border-box;
    }

    .mapboxgl-popup-content{
      font-family: 'Helvetica', sans-serif; background: #ffffff; padding: 14px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); max-width: 280px; color: #222; line-height: 1.5; border: none;
    }
    .popup-titulo{ font-size: 16px; font-weight: 600; margin-bottom: 10px; }
    .popup-etiqueta{ font-weight: bold; color: #555; }
    .popup-construccion{
      background-color: #01f3b3; color: #000; display: inline-block; padding: 6px 12px; border-radius: 6px;
      font-weight: bold; margin-bottom: 10px; font-size: 16px;
    }

    #legend-container{
      position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.95); border-radius: 6px;
      padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; font-family: 'Helvetica', sans-serif;
      max-width: 200px; box-sizing: border-box;
    }
    .legend-title{ font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333; }
    .color-bar{
      width: 100%; height: 20px; border-radius: 4px; margin-bottom: 8px;
      background: linear-gradient(to right,
        #e8f9f7, #d4f5f1, #bff1eb, #a9ede5, #94e9df, #7fe5d9, #6ae1d3, #55ddcd,
        #40d9c7, #2bd5c1, #16d1bb, #00cdb5, #00b59f, #009d89, #008473, #006b5d);
      border: 1px solid #ddd; cursor: pointer; position: relative;
    }
    .legend-labels{ display: flex; justify-content: space-between; font-size: 12px; color: #444; }
    .legend-labels span{ white-space: nowrap; }
    #legend-value{
      position: absolute; bottom: -20px; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 4px;
      font-size: 12px; color: #333; display: none; pointer-events: none;
    }

    .tooltip.mapboxgl-popup-content{
      position: absolute; z-index: 1100; display: none; pointer-events: none;
    }
    .tooltip.show{ display:block; opacity:1; transform:translateY(-2px); }

    #header{ margin:auto; width:100%; position:relative; z-index:5; text-align:center; }
    #header h1, #header h2, #header p{ margin:0; padding:1vh 1vw; color:white; }
    #footer{ width:100%; min-height:5vh; padding-top:1vh; padding-bottom:1vh; text-align:center; line-height:20px; font-size:12px; position:relative; z-index:5; color:white; }
    #features{ padding-top:10vh; padding-bottom:50vh; position:relative; z-index:2; }
    .hidden{ visibility:hidden; }
    .hide{ display:none !important; }
    .step{ width:min(500px, 92vw); margin:0 auto 80vh auto; padding:15px 20px; background-color:rgba(0,0,0,0.8); border-radius:10px; color:white; text-align:center; font-size:14px; line-height:1.5; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:3; min-height:50px; }
    .step div{ display:flex; flex-direction:column; gap:10px; }
    .step h3{ font-size:16px; margin:0 0 10px 0; font-weight:bold; color:white; }
    .step p{ margin:0; color:white; font-size:14px; }

    .legend{ position:fixed; top:20px; right:20px; background:rgba(0,0,0,0.8); color:white; padding:10px; border-radius:5px; margin-top:50px; z-index:10; font-size:12px; max-width:220px; box-shadow:0 2px 5px rgba(0,0,0,0.3); }
    .legend h4{ margin:0 0 10px 0; font-size:14px; font-weight:bold; }
    .legend-item{ display:flex; align-items:center; margin-bottom:5px; }
    .legend-color{ width:15px; height:15px; margin-right:8px; border:1px solid #fff; border-radius:3px; }
    .legend.hidden{ display:none; }
    .chapter-content iframe{ max-width:100%; width:100%; height:480px; border:none; margin-top:30px; display:block; }
    .iframe-container{ background-color:#323D4D; padding:0; border-radius:5px; max-width:100%; margin-top:10px; }
    /* Sparkline en popup */
    .popup-chart {
      width: 100%;
      max-width: 220px;
      height: 60px;
      display: block;
      margin-top: 10px;
    }
    .popup-chart-labels{
      display:flex; justify-content:space-between; font-size:12px; color:#333; margin-top:4px;
    }
    .highlight-newtral {
        background-color: #01f3b3;
        padding: 0 2px;
        border-radius: 5px;
        color: black;
    }
    @media screen and (max-width: 1024px) {
      #legend-container{ top: 10px; left: 5px; max-width: 150px; padding: 6px; }
      .legend-title{ font-size: 12px; margin-bottom: 6px; }
      .color-bar{ height: 16px; }
      .legend-labels{ font-size: 10px; }
      #geocoder-container{ left: 5px; right: 5px; }
      .mapboxgl-ctrl-geocoder{ max-width: 200px; height: 30px !important; margin-right: 5px; }
      .mapboxgl-ctrl-geocoder input{ padding-left: 30px !important; font-size: 12px; }
      #legend-value{ font-size: 10px; padding: 1px 4px; bottom: -18px; }
    }
    @media screen and (max-width: 899px) {
      .mapboxgl-ctrl-geocoder{ max-width: 180px; height: 28px !important; margin-right: 5px; }
      .mapboxgl-ctrl-geocoder input{ padding-left: 28px !important; font-size: 11px; }
    }
    @media screen and (max-width: 699px) {
      #geocoder-container{ top: 10px; justify-content: flex-end; left: 5px; right: 5px; }
      #legend-container{ top: 10px; left: 5px; max-width: 120px; padding: 4px; }
      .legend-title{ font-size: 10px; margin-bottom: 4px; }
      .color-bar{ height: 12px; }
      .legend-labels{ font-size: 8px; }
      .mapboxgl-ctrl-geocoder{ max-width: 110px; height: 22px !important; margin-right: 5px; }
      .mapboxgl-ctrl-geocoder input{ padding-left: 36px !important; font-size: 8px; }
      #legend-value{ font-size: 8px; padding: 1px 3px; bottom: -16px; }
    }

    body.free-mode{ overflow: hidden; }

    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas{ touch-action: unset; }
  </style>
</head>
<body class="dark">
  <!-- Botón para alternar modo libre / historia -->
  <button id="toggle-free" class="toggle-free">Ver mapa completo</button>

  <!-- Contenedor del mapa -->
  <div id="map"></div>

  <!-- Contenedor overlay del geocoder -->
  <div id="geocoder-container"></div>

  <!-- Leyenda -->
  <div id="legend" class="legend hidden">
    <h4>Tasa de casas vacacionales</h4>
    <div id="legend-content"></div>
  </div>

  <!-- Cabecera -->
  <div id="header" class="dark"></div>

  <!-- Historia (capítulos) -->
  <div id="features"></div>

  <!-- Pie de página  -->
  <div id="footer" class="dark"></div>

  <!-- App -->
  <script defer src="app.js"></script>
</body>
</html>